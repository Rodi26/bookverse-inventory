name: "🔧 Fix Build Permissions (Build-Info)"

on:
  workflow_dispatch:

jobs:
  fix-build-perms:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
      - name: Grant build publish perms via v1 (build section)
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT: ${{ vars.PROJECT_KEY }}
        run: |
          set -euo pipefail
          NAME="bookverse-builds-deployer"
          PT_JSON="/tmp/pt_build_v1.json"
          cat > "$PT_JSON" <<JSON
          {
            "name": "${NAME}",
            "build": {
              "includesPattern": "**/*",
              "excludesPattern": "",
              "repositories": ["${PROJECT}-build-info"],
              "actions": {
                "users": {
                  "frank.inventory@bookverse.com": ["read","write","annotate","delete","manage"],
                  "pipeline.inventory@bookverse.com": ["read","write","annotate","delete","manage"]
                },
                "groups": {}
              }
            }
          }
          JSON
          echo "Applying build permission target (v1) with project header..."
          BODY="/tmp/resp.json"
          CODE=$(curl -sS -w "%{http_code}" -o "$BODY" \
            -H "Authorization: Bearer ${JFROG_ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "X-JFrog-Project: ${PROJECT}" \
            -X PUT "${JFROG_URL}/artifactory/api/security/permissions/${NAME}" \
            -d @"$PT_JSON")
          echo "HTTP (v1): $CODE" && echo "Response:" && cat "$BODY" || true
          if [[ "$CODE" -ge 200 && "$CODE" -lt 300 ]]; then
            echo "✅ Build permission target updated (v1)"; exit 0
          fi
          echo "Falling back to v2 schema..."
          PT_JSON2="/tmp/pt_build_v2.json"
          cat > "$PT_JSON2" <<JSON
          {
            "name": "${NAME}",
            "principals": {
              "users": {
                "frank.inventory@bookverse.com": ["read","write","annotate","delete","manage"],
                "pipeline.inventory@bookverse.com": ["read","write","annotate","delete","manage"]
              },
              "groups": {}
            },
            "builds": {
              "includesPattern": "**/*",
              "excludesPattern": "",
              "repositories": ["${PROJECT}-build-info"]
            }
          }
          JSON
          CODE=$(curl -sS -w "%{http_code}" -o "$BODY" \
            -H "Authorization: Bearer ${JFROG_ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -X PUT "${JFROG_URL}/artifactory/api/v2/security/permissions/${NAME}?projectKey=${PROJECT}" \
            -d @"$PT_JSON2")
          echo "HTTP (v2): $CODE" && echo "Response:" && cat "$BODY" || true
          if [[ "$CODE" -lt 200 || "$CODE" -ge 300 ]]; then
            echo "❌ Failed to update build permission target"; exit 1
          else
            echo "✅ Build permission target updated (v2)"
          fi
