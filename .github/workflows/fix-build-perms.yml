name: "🔧 Fix Build Permissions (Build-Info)"

on:
  workflow_dispatch:

jobs:
  fix-build-perms:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
      - name: Grant build publish perms via v2 (builds section)
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT: ${{ vars.PROJECT_KEY }}
        run: |
          set -euo pipefail
          NAME="bookverse-builds-deployer"
          PT_JSON2="/tmp/pt_build_v2.json"
          cat > "$PT_JSON2" <<JSON
          {
            "name": "${NAME}",
            "projectKey": "${PROJECT}",
            "builds": {
              "includesPattern": "**/*",
              "excludesPattern": "",
              "actions": {
                "users": {
                  "frank.inventory@bookverse.com": ["read","manage","annotate"],
                  "pipeline.inventory@bookverse.com": ["read","manage","annotate"]
                },
                "groups": {}
              }
            }
          }
          JSON
          BODY="/tmp/resp.json"
          CODE=$(curl -sS -w "%{http_code}" -o "$BODY" \
            -H "Authorization: Bearer ${JFROG_ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -X PUT "${JFROG_URL}/artifactory/api/v2/security/permissions/${NAME}?projectKey=${PROJECT}" \
            -d @"$PT_JSON2")
          echo "HTTP (v2): $CODE" && echo "Response:" && cat "$BODY" || true
          if [[ "$CODE" -lt 200 || "$CODE" -ge 300 ]]; then
            echo "❌ Failed to update build permission target"; exit 1
          else
            echo "✅ Build permission target updated (v2)"
          fi
