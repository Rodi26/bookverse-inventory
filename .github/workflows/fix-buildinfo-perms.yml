name: "🔧 Fix Build-Info Repo Permissions"

on:
  workflow_dispatch:

jobs:
  fix-perms:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
      - name: Grant deploy perms on build-info repo (project-scoped)
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT: ${{ vars.PROJECT_KEY }}
        run: |
          set -euo pipefail
          NAME="bookverse-build-info-deployers"
          REPO_KEY="${PROJECT}-build-info"
          PT_JSON="/tmp/pt.json"
          cat > "$PT_JSON" <<JSON
          {
            "name": "${NAME}",
            "projectKey": "${PROJECT}",
            "repo": {
              "repositories": ["${REPO_KEY}"],
              "includesPattern": "**/*",
              "excludesPattern": ""
            },
            "principals": {
              "users": {
                "frank.inventory@bookverse.com": ["read","write","annotate","delete"],
                "pipeline.inventory@bookverse.com": ["read","write","annotate","delete"]
              },
              "groups": {}
            }
          }
          JSON
          echo "Applying permission target via v1 API with project header..."
          BODY="/tmp/resp.json"
          CODE=$(curl -sS -w "%{http_code}" -o "$BODY" \
            -H "Authorization: Bearer ${JFROG_ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "X-JFrog-Project: ${PROJECT}" \
            -X PUT "${JFROG_URL}/artifactory/api/security/permissions/${NAME}" \
            -d @"$PT_JSON")
          echo "HTTP: $CODE" && cat "$BODY" || true
          if [[ "$CODE" -lt 200 || "$CODE" -ge 300 ]]; then
            echo "Falling back to v2 API with projectKey query..."
            CODE=$(curl -sS -w "%{http_code}" -o "$BODY" \
              -H "Authorization: Bearer ${JFROG_ADMIN_TOKEN}" \
              -H "Content-Type: application/json" \
              -X PUT "${JFROG_URL}/artifactory/api/v2/security/permissions/${NAME}?projectKey=${PROJECT}" \
              -d @"$PT_JSON")
            echo "HTTP (v2): $CODE" && cat "$BODY" || true
          fi
          if [[ "$CODE" -lt 200 || "$CODE" -ge 300 ]]; then
            echo "❌ Failed to update permission target"; exit 1
          else
            echo "✅ Permission target updated"
          fi
