name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest

      - name: Configure JFrog CLI
        run: |
          jf c add --interactive=false --url "${{ vars.JFROG_URL }}" --access-token ""
          jf c show

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine pytest pytest-cov httpx cyclonedx-bom

      - name: Install project dependencies
        run: |
          pip install -r requirements.txt

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=html
          
      - name: Build Python packages
        run: |
          python -m build
          ls -la dist/

      - name: Generate Python SBOM
        run: |
          cyclonedx-py requirements -o sbom-python.json
          ls -la *.json

      - name: Build Docker image
        run: |
          SERVICE_NAME=$(echo ${{ github.event.repository.name }} | sed 's/bookverse-//')
          IMAGE_TAG=$(echo $GITHUB_SHA | head -c7)
          IMAGE_NAME="${{ vars.PROJECT_KEY }}-${SERVICE_NAME}-docker-internal-local/${SERVICE_NAME}:${IMAGE_TAG}"
          docker build -t ${{ vars.DOCKER_REGISTRY }}/$IMAGE_NAME .
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Generate Docker SBOM
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            anchore/syft ${{ vars.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }} -o cyclonedx-json=sbom-docker.json || \
            echo '{"bomFormat": "CycloneDX", "specVersion": "1.4", "components": []}' > sbom-docker.json

      - name: Login to Docker registry
        run: |
          jf docker login "${{ vars.DOCKER_REGISTRY }}"

      - name: Push Python packages
        run: |
          jf rt upload "dist/*.whl" "${{ vars.PROJECT_KEY }}-${{ env.SERVICE_NAME }}-python-internal-local/" \
            --build-name="${{ env.SERVICE_NAME }}" --build-number="${{ env.IMAGE_TAG }}"
          jf rt upload "dist/*.tar.gz" "${{ vars.PROJECT_KEY }}-${{ env.SERVICE_NAME }}-python-internal-local/" \
            --build-name="${{ env.SERVICE_NAME }}" --build-number="${{ env.IMAGE_TAG }}"

      - name: Push Docker image
        run: |
          docker push ${{ vars.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Upload SBOMs and test results
        run: |
          jf rt upload "sbom-*.json" "${{ vars.PROJECT_KEY }}-${{ env.SERVICE_NAME }}-generic-internal-local/sbom/" \
            --build-name="${{ env.SERVICE_NAME }}" --build-number="${{ env.IMAGE_TAG }}"
          jf rt upload "coverage.xml" "${{ vars.PROJECT_KEY }}-${{ env.SERVICE_NAME }}-generic-internal-local/reports/" \
            --build-name="${{ env.SERVICE_NAME }}" --build-number="${{ env.IMAGE_TAG }}" || echo "No coverage report found"
          jf rt upload "htmlcov/**" "${{ vars.PROJECT_KEY }}-${{ env.SERVICE_NAME }}-generic-internal-local/reports/coverage/" \
            --build-name="${{ env.SERVICE_NAME }}" --build-number="${{ env.IMAGE_TAG }}" || echo "No HTML coverage found"

      - name: Publish build info
        run: |
          jf rt build-publish "${{ env.SERVICE_NAME }}" "${{ env.IMAGE_TAG }}"


